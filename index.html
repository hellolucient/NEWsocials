<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI & Wellness Post Generator</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { margin: 10px 0; padding: 5px 10px; cursor: pointer; }
        #newsList, #platformSelection, #generatedPosts, #mediaContent { margin-top: 20px; }
        .media-item { display: flex; align-items: center; margin-bottom: 10px; }
        .media-item img, .media-item audio { margin-right: 10px; max-width: 100px; }
        .platform-post { margin-bottom: 20px; background-color: #f0f0f0; padding: 10px; border-radius: 5px; }
        #platformSelection label { margin-right: 10px; }
        #loadingIndicator { display: none; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>AI & Wellness Post Generator</h1>
    
    <input type="text" id="topic" value="AI & Wellness">
    <button id="fetchButton">Fetch Content</button>
    <div id="loadingIndicator">Loading...</div>
    
    <div id="newsList"></div>
    <div id="mediaContent"></div>
    <div id="platformSelection" style="display:none;">
        <h2>Select Platforms:</h2>
        <label><input type="checkbox" name="platform" value="twitter"> Twitter</label>
        <label><input type="checkbox" name="platform" value="facebook"> Facebook</label>
        <label><input type="checkbox" name="platform" value="linkedin"> LinkedIn</label>
        <label><input type="checkbox" name="platform" value="instagram"> Instagram</label>
        <label><input type="checkbox" name="platform" value="tiktok"> TikTok</label>
    </div>
    <button id="generateButton" style="display:none;">Generate Posts</button>
    
    <div id="generatedPosts"></div>

    <script>
        const API_URL = 'https://api-test-suite.vercel.app'; // Make sure this matches your Vercel deployment URL

        let newsArticles = [];
        let mediaContent = { images: [], sounds: [] };

        async function fetchContent() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.style.display = 'block';
            const topic = document.getElementById('topic').value;
            console.log('Fetching content for topic:', topic);
            try {
                // Fetch news
                console.log('Fetching news from:', `${API_URL}/api/news/top-headlines?q=${encodeURIComponent(topic)}`);
                const newsResponse = await fetch(`${API_URL}/api/news/top-headlines?q=${encodeURIComponent(topic)}`, {
                    credentials: 'include'
                });
                console.log('News response status:', newsResponse.status);
                console.log('News response headers:', Object.fromEntries(newsResponse.headers));
                if (!newsResponse.ok) {
                    throw new Error(`HTTP error! status: ${newsResponse.status}`);
                }
                const newsText = await newsResponse.text();
                console.log('News response text:', newsText);
                const newsData = JSON.parse(newsText);
                console.log('News data:', newsData);
                newsArticles = newsData.articles ? newsData.articles.slice(0, 5) : []; // Limit to 5 articles
                displayNews(newsArticles);

                // Fetch images from Pexels and Pixabay
                const pexelsResponse = await fetch(`${API_URL}/api/pexels/search?query=${encodeURIComponent(topic)}`, {
                    credentials: 'include'
                });
                const pexelsData = await pexelsResponse.json();
                const pixabayResponse = await fetch(`${API_URL}/api/pixabay/search?query=${encodeURIComponent(topic)}`, {
                    credentials: 'include'
                });
                const pixabayData = await pixabayResponse.json();

                // Fetch sounds from Freesound
                const freesoundResponse = await fetch(`${API_URL}/api/freesound/search?query=${encodeURIComponent(topic)}`, {
                    credentials: 'include'
                });
                const freesoundData = await freesoundResponse.json();

                mediaContent.images = [...(pexelsData.photos || []), ...(pixabayData.hits || [])];
                mediaContent.sounds = freesoundData.results || [];

                displayMedia(mediaContent);
            } catch (error) {
                console.error('Error fetching content:', error);
                alert('Error fetching content: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        function displayNews(articles) {
            const newsList = document.getElementById('newsList');
            if (articles.length === 0) {
                newsList.innerHTML = '<h2>No news articles found for this topic.</h2>';
                return;
            }
            newsList.innerHTML = '<h2>Select news topics:</h2>';
            articles.forEach((article, index) => {
                newsList.innerHTML += `
                    <div>
                        <input type="checkbox" id="article${index}" name="article" value="${index}">
                        <label for="article${index}">${article.title}</label>
                    </div>
                `;
            });
            document.getElementById('platformSelection').style.display = 'block';
            document.getElementById('generateButton').style.display = 'block';
        }

        function displayMedia(content) {
            const mediaContent = document.getElementById('mediaContent');
            if (content.images.length === 0 && content.sounds.length === 0) {
                mediaContent.innerHTML = '<h2>No related media found.</h2>';
                return;
            }
            mediaContent.innerHTML = '<h2>Related Media:</h2>';

            // Display images
            content.images.slice(0, 5).forEach(image => {
                const imgSrc = image.src ? image.src.small : image.previewURL;
                const credit = image.photographer || image.user;
                mediaContent.innerHTML += `
                    <div class="media-item">
                        <img src="${imgSrc}" alt="${credit}" width="100">
                        <span>${credit}</span>
                    </div>
                `;
            });

            // Display sounds
            content.sounds.slice(0, 3).forEach(sound => {
                mediaContent.innerHTML += `
                    <div class="media-item">
                        <audio controls src="${sound.previews['preview-hq-mp3']}"></audio>
                        <span>${sound.name}</span>
                    </div>
                `;
            });
        }

        function generatePosts() {
            const selectedArticles = Array.from(document.querySelectorAll('input[name="article"]:checked'))
                .map(checkbox => newsArticles[checkbox.value]);
            const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platform"]:checked'))
                .map(checkbox => checkbox.value);
            
            const generatedPosts = document.getElementById('generatedPosts');
            
            if (selectedArticles.length === 0 || selectedPlatforms.length === 0) {
                generatedPosts.innerHTML = '<h2>Please select at least one article and one platform.</h2>';
                return;
            }
            
            generatedPosts.innerHTML = '<h2>Generated Posts:</h2>';

            for (const article of selectedArticles) {
                for (const platform of selectedPlatforms) {
                    const post = generatePostForPlatform(article, platform);
                    generatedPosts.innerHTML += `
                        <div class="platform-post">
                            <h3>${platform.charAt(0).toUpperCase() + platform.slice(1)} Post:</h3>
                            <p>${post}</p>
                            <button onclick="copyToClipboard(this.previousElementSibling.textContent)">Copy</button>
                        </div>
                    `;
                }
            }
        }

        function generatePostForPlatform(article, platform) {
            const hashtags = '#AIWellness #HealthTech';
            const shortUrl = article.url.replace(/^https?:\/\//, '');
            const image = mediaContent.images[Math.floor(Math.random() * mediaContent.images.length)];
            const imgText = image ? `[Image: ${image.src ? image.src.small : image.previewURL}]` : '';

            switch(platform) {
                case 'twitter':
                    return `${article.title.substring(0, 100)}... ${hashtags}\n${imgText}\nRead more: ${shortUrl}`;
                case 'facebook':
                    return `${article.title}\n\n${article.description}\n\n${imgText}\n\nRead the full story: ${article.url}\n${hashtags}`;
                case 'linkedin':
                    return `I found this interesting article on AI & Wellness:\n\n${article.title}\n\n${article.description}\n\n${imgText}\n\nWhat are your thoughts on this?\n\nRead more: ${article.url}\n${hashtags}`;
                case 'instagram':
                    return `${article.title.substring(0, 100)}...\n\n${imgText}\n\nWant to know more? Check out the link in bio!\n${hashtags}`;
                case 'tiktok':
                    return `${article.title.substring(0, 100)}...\n\n${imgText}\n\nStay tuned for more tech health updates!\nFull story: ${shortUrl}\n${hashtags}`;
                default:
                    return `Check out this AI & Wellness news: ${article.title}\n\n${imgText}\n\nRead more: ${article.url}`;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }, (err) => {
                console.error('Could not copy text: ', err);
            });
        }

        async function testAPI() {
            try {
                const response = await fetch(`${API_URL}/api/test`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Test API response:', data);
            } catch (error) {
                console.error('Error testing API:', error);
            }
        }

        async function testCORS() {
            try {
                const response = await fetch(`${API_URL}/api/cors-test`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('CORS test response:', data);
            } catch (error) {
                console.error('Error testing CORS:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fetchButton').addEventListener('click', fetchContent);
            document.getElementById('generateButton').addEventListener('click', generatePosts);
            testAPI();
            testCORS();
        });
    </script>
</body>
</html>
